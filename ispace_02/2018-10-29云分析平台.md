---
title: 2018-10-29云分析平台
tags: 爱空间,云分析
---

# 存储过程备份
2018年12月13日 20时22分01秒

``` sql

ALTER PROCEDURE [dbo].[PF_ETL_Conversion] 
	-- Add the parameters for the stored procedure here
	
AS
BEGIN
	
	if  exists(select *  from tempdb..sysobjects where name like '#T1%')
	     drop table #T1
     	
	if  exists(select *  from tempdb..sysobjects where name like '#T2%')
	     drop table #T2

	if  exists(select *  from tempdb..sysobjects where name like '#T3%')
				drop table #T3

	-- if  exists(select *  from tempdb..sysobjects where name like '#T3%')
	 --    drop table #T3

-- 按照规则取时间

/* -- 20181203 shg 更新规则，新增若所有时间小于订单创建时间则取订单创建时间
select 
	user_id
	,contract_date
	,case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end payment_date
	,case  doc_enter_store_date when  '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end doc_enter_store_date
	,case  doc_first_vaild_date when  '2099/12/31 00:00:00.000' then (case  doc_enter_store_date when '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end ) 
 else doc_first_vaild_date end doc_first_vaild_date
into #T1
from (
select user_id
	,min(case  when doc_first_vaild_date is null then '2099/12/31 00:00:00.000' else doc_first_vaild_date end)  doc_first_vaild_date
	,min( case  when doc_enter_store_date is null then '2099/12/31 00:00:00.000' else doc_enter_store_date end ) doc_enter_store_date
	,min( case  when payment_date is null then '2099/12/31 00:00:00.000' else payment_date end ) payment_date
	,min( case  when contract_date is null then '2099/12/31 00:00:00.000' else contract_date end ) contract_date
	from [dbo].[Fact_Decorate_Order]
	-- where user_id = 612303
	group by user_id ) a

20181203 shg */
SELECT
	user_id
	,contract_date
	,case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end payment_date
	,case  doc_enter_store_date when  '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end doc_enter_store_date
	,case  doc_first_vaild_date when  '2099/12/31 00:00:00.000' then (case  doc_enter_store_date when '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end ) 
 else doc_first_vaild_date end doc_first_vaild_date
into #T1
from (
select user_id
	,min(case  when doc_first_vaild_date is null then '2099/12/31 00:00:00.000' else (case when doc_first_vaild_date<create_date then create_date else doc_first_vaild_date end) end)  doc_first_vaild_date
	,min( case  when doc_enter_store_date is null then '2099/12/31 00:00:00.000' else (case when doc_enter_store_date<create_date then create_date else doc_enter_store_date end) end ) doc_enter_store_date
	,min( case  when payment_date is null then '2099/12/31 00:00:00.000' else (case when payment_date<create_date then create_date else payment_date end) end ) payment_date
	,min( case  when contract_date is null then '2099/12/31 00:00:00.000' else (case when contract_date<create_date then create_date else contract_date end) end ) contract_date
	from [dbo].[Fact_Decorate_Order]
	-- where user_id = 612303
	group by user_id ) a





select a.user_id 
,orders_no 
,Rank
,create_date
,create_time
,doc_first_vaild_user -- 首次有效人
,doc_first_vaild_date 
,doc_enter_store_date
,payment_date
,un_payment_date
,contract_date
,amount
,total_amount
,payment_category
,un_payment_category
,order_states -- 订单状态
,area_code　-- 区域
,source_no -- 渠道编号
,platform -- 平台编号
,deposit_pay_sign
 into #T2
from (select top 1000000*,Row_Number()OVER(PARTITION BY user_id ORDER BY user_id,create_date) AS Rank from [dbo].[Fact_Decorate_Order]
 order by user_id,create_date) a where Rank=1

 

 select user_id
,Sum(amount) amount 
	,sum(total_amount) total_amount
	,SUM(payment_category) payment_category
	,SUM(un_payment_category) un_payment_category
into #T3 from [dbo].[Fact_Decorate_Order] group by user_id

  TRUNCATE table Fact_Decorate_Order_User

  insert into  Fact_Decorate_Order_User

 select 
	b.orders_no
,b.create_date
,b.create_time
	,a.user_id
	,case a.doc_first_vaild_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.doc_first_vaild_date) end doc_first_vaild_date
	,case a.doc_enter_store_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.doc_enter_store_date) end doc_enter_store_date
	,case a.payment_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.payment_date) end payment_date
	,case a.contract_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.contract_date) end contract_date 

	,case a.doc_first_vaild_date when  '2099/12/31 00:00:00.000' then 0 else 1  end doc_first_vaild_date_state
	,case a.doc_enter_store_date when  '2099/12/31 00:00:00.000' then 0 else 1  end doc_enter_store_date_state
	,case a.payment_date when  '2099/12/31 00:00:00.000' then 0 else 1  end payment_date_state
	,case a.contract_date when  '2099/12/31 00:00:00.000' then 0 else 1  end contract_date_state
	,b.source_no
	,b.platform
	,b.area_code
	,b.order_states
	,c.amount
	,c.total_amount
	,c.payment_category
	,c.un_payment_category
	,b.doc_first_vaild_user   -- 首次有效人

from #T1 a INNER JOIN #T2 b on a.user_id = b.user_id 
left JOIN #T3 c on a.user_id = c.user_id

END

```