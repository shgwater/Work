---
title: 2019-3-6工作代码备份
tags: 新建,模板,小书匠
grammar_cjkRuby: true
---
# 成本毛利
## 理论毛利部分
 门店-套餐-空间-施工项 对应的选材维度的**所有订单的统计数量**
``` sql
select * from (SELECT
	store_no
	,product_no
	,case_space
	,case_space_no
	,work_item_no
	,dimension_no
	,count(1) num
FROM
	(

		SELECT
			b.store_no,
			b.product_no,
			a.design_case_no,
			REPLACE (
				REPLACE (a.case_space_no, '1', ''),
				'2',
				''
			) case_space,
			SUBSTRING(a.case_space_no ,-1) case_space_no,
			a.work_item_no,
			a.case_work_item_no,
			a.dimension_no,
			count(1) num
		FROM
			design.design_case_work_item a 
			LEFT JOIN(
				-- 设计实例/门店/套餐/订单编号关联表
				SELECT
					a.design_case_no
					,a.store_no
					,b.*
				FROM
					design.design_case a
				LEFT JOIN (
					SELECT DISTINCT
						contract_no,
						product_no
					FROM
						design.quotation
				) b
				on a.contract_no = b.contract_no
			) b
			on a.design_case_no=b.design_case_no
		WHERE		a.is_checked = '1' -- AND a.design_case_no LIKE '200011%'
		GROUP BY
			b.store_no,
			b.product_no,
			a.design_case_no,
			a.case_space_no,
			a.work_item_no,
			a.case_work_item_no,
			a.dimension_no
	) a
group by 
	store_no
	,product_no
	,case_space
	,case_space_no
	,work_item_no
	,dimension_no
) b
order by 
	store_no
	,product_no
	,case_space
	,case_space_no
	,work_item_no
	,num desc 





-- 设计实例/门店/套餐/订单编号关联表
SELECT
	a.design_case_no
	,a.store_no
	,b.*
FROM
	design.design_case a
LEFT JOIN (
	SELECT DISTINCT
		contract_no,
		product_no
	FROM
		design.quotation
) b
on a.contract_no = b.contract_no



```