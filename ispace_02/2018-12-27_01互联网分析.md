---
title: 2019-1-7analysis cloud ETL Backup
tags: 新建,模板,小书匠
grammar_cjkRuby: true
---

# ETL
## 01互联网营销分析
### 60051
订单 Fact_Decorate_Order

``` sql
select A.id
,A.orders_no  -- 订单号
,DATE(A.create_time) create_date -- 订单创建时间 cc：拆分时间和日期
,STR_TO_DATE( CONCAT('2000-01-01',time(A.create_time)) ,'%Y-%m-%d %H:%i:%s') create_time-- 订单创建时间 cc：拆分时间和日期
,A.platform  -- 平台 pc/M
,A.user_id -- 用户id
,A.user_name -- 用户名称
,A.order_states --  'erp订单状态：10-待付定金，20-待约合开工日期，40-待派单，50-待约合排列日期，51-待分配排雷工人，52-待排雷反馈，60-待设计报价状态，90-待审核报价状态，91-待复核报价状态，150-待签约，155-待审核合同，150-已签约，170-施工中，200-已竣工，300-已过期，400-已退款',
 -- ,shop_no -- 门店编码 -- 无数据
,A.area_code -- 门店区域编码
,A.amount  -- 订单表定金
,A.gender  --  '0：女；1：男',
,A.orders_type -- 订单房屋类型：0新1旧
,A.activity_code -- 活动标识
,A.deposit_pay_sign -- 订金支付标识1:订金小于500大于0,2：订金大于等于500  decorate_order_pay 中的金额
-- 20181206(更新渠道对应方案，渠道编号为空的) ,B.source_no as source_no -- 推广渠道编号
,(case when B.source_no is null or B.source_no='' then A.platform else B.source_no end) as source_no -- 推广渠道编号
-- ,C.doc_order_no -- 订单号
,date(C.doc_first_vaild_date) doc_first_vaild_date -- 首次有效时间
,date(C.doc_plan_enter_store_date) doc_plan_enter_store_date -- 预约进店时间
,date(C.doc_enter_store_date) doc_enter_store_date -- 客户进店日期
,C.doc_first_vaild_user -- 首次首次有效人 20181207 
,C.doc_first_vaild_user_code -- 首次首次有效人编号 20181212  worker 表
,E.customer_manager -- 客户经理姓名 20181212 -- decorate_order_bussiness 应该用这张表的
,E.project_manager -- 项目经理姓名 20181212
,E.designer -- 设计师姓名 20181212
,E.customer_manager_no -- '客户经理编号',20181212
,E.project_manager_no --  '项目经理编号',20181212
,E.designer_no -- '设计师编号',20181212
,C.doc_history_kf_code -- 历史客服编号 20181212
,C.doc_order_repeat -- 重复订单，0否，1是   20181212
,C.doc_invalid_confirm_state  -- 无效确认0否1是 20181212
,C.doc_check_num -- 跟进次数 20181212
,D.un_payment_category -- 退款金额
,D.payment_category-- 回款金额
,date(D.payment_date) payment_date -- 交订时间
,date(D.un_payment_date) un_payment_date -- 退订时间
,case when A.deposit_pay_sign = 2 and  D.payment_date is not null then date(D.payment_date) else null end payment_date_500-- 交订满 500 日期
,case when A.deposit_pay_sign = 2 and  D.un_payment_date is not null then date(D.un_payment_date) else null end un_payment_date_500-- 交订满 500 日期
,date(E.contract_date) contract_date -- 实际签约时间
,F.total_amount -- 合同金额
,G.region_id -- 房屋区域
,G.community -- 小区名称
,G.house_category -- 房屋类别
,G.house_type -- 房屋户型
,G.area -- 房屋面积
,G.measure_area -- 实际测量面积 
,G.house_prop -- 房屋属性
,G.house_decorate_state -- 新老房
,G.building_year -- 建造年份（数据字典）

from decorate_order A
LEFT JOIN decorate_order_source B on A.orders_no = B.orders_no
LEFT JOIN decorate_order_check C on A.orders_no = C.doc_order_no
LEFT JOIN 
(select  orders_no
  ,sum(case when payment_category in (6,7,11) then payment_amount else 0 end)  un_payment_category
	, sum(case when payment_category in (6,7,11) then 0 else payment_amount end) payment_category
  , min(case when payment_category in (6,7,11) then null else payment_time end) payment_date
  , min(case when payment_category in (6,7,11) then null else create_time end) create_payment_date  -- 交订创建时间
  , max(case when payment_category in (6,7,11) then payment_time else null end) un_payment_date
  , max(case when payment_category in (6,7,11) then create_time else null end) create_un_payment_date -- 退订单创建时间
  from decorate_order_pay  -- where orders_no	= 'DD20180823000473'
group by orders_no) D on A.orders_no = D.orders_no
LEFT JOIN decorate_order_bussiness E on A.orders_no = E.orders_no
LEFT JOIN decorate_order_amount F on A.orders_no = F.orders_no
LEFT JOIN decorate_order_house G on A.orders_no = G.order_no
-- where A.orders_no	= 'DD20181119001189';
/* 20181213 update 增加字段
select A.id
,A.orders_no  -- 订单号
,DATE(A.create_time) create_date -- 订单创建时间 cc：拆分时间和日期
,STR_TO_DATE( CONCAT('2000-01-01',time(A.create_time)) ,'%Y-%m-%d %H:%i:%s') create_time-- 订单创建时间 cc：拆分时间和日期
,A.platform  -- 平台 pc/M
,A.user_id -- 用户id
,A.order_states --  'erp订单状态：10-待付定金，20-待约合开工日期，40-待派单，50-待约合排列日期，51-待分配排雷工人，52-待排雷反馈，60-待设计报价状态，90-待审核报价状态，91-待复核报价状态，150-待签约，155-待审核合同，150-已签约，170-施工中，200-已竣工，300-已过期，400-已退款',
 -- ,shop_no -- 门店编码 -- 无数据
,A.area_code -- 门店区域编码
,A.amount  -- 定金
,A.gender  --  '0：女；1：男',
,A.orders_type -- 订单房屋类型：0新1旧
,A.activity_code -- 活动标识
,A.deposit_pay_sign -- 订金支付标识1:订金小于500大于0,2：订金大于等于500
-- 20181206(更新渠道对应方案，渠道编号为空的) ,B.source_no as source_no -- 推广渠道编号
,(case when B.source_no is null or B.source_no='' then A.platform else B.source_no end) as source_no -- 推广渠道编号
-- ,C.doc_order_no -- 订单号
,date(C.doc_first_vaild_date) doc_first_vaild_date -- 首次有效时间
,date(C.doc_plan_enter_store_date) doc_plan_enter_store_date -- 预约进店时间
,date(C.doc_enter_store_date) doc_enter_store_date -- 客户进店日期

,C.doc_first_vaild_user -- 首次首次有效人 20181207 
,D.un_payment_category -- 退订金额
,D.payment_category-- 交订金额
,date(D.payment_date) payment_date -- 交订时间
,date(D.un_payment_date) un_payment_date -- 退订时间
,date(E.contract_date) contract_date -- 实际签约时间
,F.total_amount -- 合同金额
,G.region_id -- 房屋区域
,G.community -- 小区名称
,G.house_category -- 房屋类别
,G.house_type -- 房屋户型
,G.area -- 房屋面积
,G.measure_area -- 实际测量面积 
,G.house_prop -- 房屋属性
,G.house_decorate_state -- 新老房
,G.building_year -- 建造年份（数据字典）

from decorate_order A
LEFT JOIN decorate_order_source B on A.orders_no = B.orders_no
LEFT JOIN decorate_order_check C on A.orders_no = C.doc_order_no
LEFT JOIN 
(select  orders_no, sum(case when payment_category in (6,7,11) then payment_amount else 0 end)  un_payment_category
	, sum(case when payment_category in (6,7,11) then 0 else payment_amount end) payment_category
  , min(case when payment_category in (6,7,11) then null else payment_time end) payment_date
  , max(case when payment_category in (6,7,11) then payment_time else null end) un_payment_date
  from decorate_order_pay -- where orders_no	= 'DD20180823000473'
group by orders_no) D on A.orders_no = D.orders_no
LEFT JOIN decorate_order_bussiness E on A.orders_no = E.orders_no
LEFT JOIN decorate_order_amount F on A.orders_no = F.orders_no
LEFT JOIN decorate_order_house G on A.orders_no = G.order_no;
*/
```
执行ETL后时间
``` sql
exec PF_ETL_Conversion 
```
#### PF_ETL_Conversion
``` sql

ALTER PROCEDURE [dbo].[PF_ETL_Conversion] 
	-- Add the parameters for the stored procedure here
	
AS
BEGIN
	
	if  exists(select *  from tempdb..sysobjects where name like '#T1%')
	     drop table #T1
     	
	if  exists(select *  from tempdb..sysobjects where name like '#T2%')
	     drop table #T2

	if  exists(select *  from tempdb..sysobjects where name like '#T3%')
				drop table #T3

	if  exists(select *  from tempdb..sysobjects where name like '#T4%')
				drop table #T4
	-- if  exists(select *  from tempdb..sysobjects where name like '#T3%')
	 --    drop table #T3

-- 按照规则取时间

/* -- 20181203 shg 更新规则，新增若所有时间小于订单创建时间则取订单创建时间
select 
	user_id
	,contract_date
	,case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end payment_date
	,case  doc_enter_store_date when  '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end doc_enter_store_date
	,case  doc_first_vaild_date when  '2099/12/31 00:00:00.000' then (case  doc_enter_store_date when '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end ) 
 else doc_first_vaild_date end doc_first_vaild_date
into #T1
from (
select user_id
	,min(case  when doc_first_vaild_date is null then '2099/12/31 00:00:00.000' else doc_first_vaild_date end)  doc_first_vaild_date
	,min( case  when doc_enter_store_date is null then '2099/12/31 00:00:00.000' else doc_enter_store_date end ) doc_enter_store_date
	,min( case  when payment_date is null then '2099/12/31 00:00:00.000' else payment_date end ) payment_date
	,min( case  when contract_date is null then '2099/12/31 00:00:00.000' else contract_date end ) contract_date
	from [dbo].[Fact_Decorate_Order]
	-- where user_id = 612303
	group by user_id ) a

20181203 shg */
select 
	user_id
	,contract_date
	,case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end payment_date
	,case  doc_enter_store_date when  '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end doc_enter_store_date
	,case  doc_first_vaild_date when  '2099/12/31 00:00:00.000' then (case  doc_enter_store_date when '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end ) 
 else doc_first_vaild_date end doc_first_vaild_date
into #T1
from (
select user_id
	,min(case  when doc_first_vaild_date is null then '2099/12/31 00:00:00.000' else (case when doc_first_vaild_date<create_date then create_date else doc_first_vaild_date end) end)  doc_first_vaild_date
	,min( case  when doc_enter_store_date is null then '2099/12/31 00:00:00.000' else (case when doc_enter_store_date<create_date then create_date else doc_enter_store_date end) end ) doc_enter_store_date
	,min( case  when payment_date_500 is null then '2099/12/31 00:00:00.000' else (case when payment_date_500<create_date then create_date else payment_date_500 end) end ) payment_date
	,min( case  when contract_date is null then '2099/12/31 00:00:00.000' else (case when contract_date<create_date then create_date else contract_date end) end ) contract_date
	from [dbo].[Fact_Decorate_Order]
	-- where user_id = 612303
	group by user_id ) a





select a.user_id 
,orders_no 
,Rank
,create_date
,create_time
,doc_first_vaild_user -- 首次有效人
,doc_first_vaild_date 
,doc_enter_store_date
,payment_date_500 as payment_date
,un_payment_date_500 as un_payment_date
,contract_date
,amount
,total_amount
,payment_category
,un_payment_category
,order_states -- 订单状态
,area_code　-- 区域
,source_no -- 渠道编号
,platform -- 平台编号
,deposit_pay_sign
 into #T2
from (select top 1000000*,Row_Number()OVER(PARTITION BY user_id ORDER BY user_id,create_date,create_time) AS Rank from [dbo].[Fact_Decorate_Order]
 order by user_id,create_date) a where Rank=1

 

 select user_id
,Sum(amount) amount 
	,sum(total_amount) total_amount
	,SUM(payment_category) payment_category
	,SUM(un_payment_category) un_payment_category
into #T3 from [dbo].[Fact_Decorate_Order] group by user_id

/*
begin 20181217 穿刺表新增用户签约数量字段
*/
select user_id 
,COUNT(contract_date) as contract_date_num -- 用户签约订单数量
,min(case when payment_date_500 is not null and (order_states='400' or payment_category=un_payment_category ) then un_payment_date_500 else null end) as un_payment_date_500 -- 用户退订时间
,count(case when payment_date_500 is not null and (order_states='400' or payment_category=un_payment_category ) then un_payment_date_500 else null end) as un_payment_date_num -- 用户退订单数
,count(payment_date_500) payment_date_num -- 用户交订单数
into #T4 
from Fact_Decorate_Order
group by user_id 
/*
begin 20181217
*/

  TRUNCATE table Fact_Decorate_Order_User

  insert into  Fact_Decorate_Order_User

 -- drop table Fact_Decorate_Order_User

 select 
	b.orders_no
,b.create_date
,b.create_time
	,a.user_id
	,case a.doc_first_vaild_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.doc_first_vaild_date) end doc_first_vaild_date
	,case a.doc_enter_store_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.doc_enter_store_date) end doc_enter_store_date
	,case a.payment_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.payment_date) end payment_date
	,d.un_payment_date_500 -- 20181217 最早退订时间
	,case a.contract_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.contract_date) end contract_date 

	,case a.doc_first_vaild_date when  '2099/12/31 00:00:00.000' then 0 else 1  end doc_first_vaild_date_state
	,case a.doc_enter_store_date when  '2099/12/31 00:00:00.000' then 0 else 1  end doc_enter_store_date_state
	,case a.payment_date when  '2099/12/31 00:00:00.000' then 0 else 1  end payment_date_state
	,case when d.un_payment_date_500 is null then 0 else 1 end un_payment_date_user_num  -- 20181217 退订人数
	,case a.contract_date when  '2099/12/31 00:00:00.000' then 0 else 1  end contract_date_state
	,d.contract_date_num  -- 20181217 签约订单数量
	,d.un_payment_date_num -- 20181217 用户退订单数
	,d.payment_date_num -- 20181217 用户交订单数
	,b.source_no
	,b.platform
	,b.area_code
	,b.order_states
	,c.amount
	,c.total_amount
	,c.payment_category
	,c.un_payment_category
	,b.doc_first_vaild_user   -- 首次有效人

-- into Fact_Decorate_Order_User
from #T1 a INNER JOIN #T2 b on a.user_id = b.user_id 
left JOIN #T3 c on a.user_id = c.user_id
left join #T4 d on a.user_id = d.user_id

/*
		20181213 增加订单明细标准表，与源表不同之处在于，每条订单对应了首次订单编号
start*/

TRUNCATE table Fact_Decorate_Order_Std

insert into  Fact_Decorate_Order_Std
SELECT
	b.orders_no AS first_orders_no,
	b.source_no as first_source_no,
	a.* -- INTO Fact_Decorate_Order_Std
FROM
	Fact_Decorate_Order a
LEFT JOIN (
	SELECT
		source_no,
		orders_no,
		user_id
	FROM
		Fact_Decorate_Order_user
) b ON a.user_id = b.user_id

/*
		20181213 增加订单明细标准表，与源表不同之处在于，每条订单对应了首次订单编号0
end*/




END

```

### 61009
回款详情表 Fact_Decorate_Order_Pay
``` sql
/*
select a.id 
,a.orders_no
,company
,payment_category
,case when payment_category in (6,7,11) then payment_amount*-1 else payment_amount end payment_amount
,payment_time
,a.create_time
,b.area_code
,b.platform
,case when c.source_no  is null or c.source_no='' then b.platform else c.source_no end as source_no 
 from decorate_order_pay a 
left JOIN decorate_order b on a.orders_no = b.orders_no 
left join decorate_order_source c on a.orders_no = c.orders_no 

-- 20181210更新，使用浩哥的逻辑进行处理
select a.id 
,a.orders_no
,a.first_orders_no
,a.company
,payment_category
,case when payment_category in (6,7,11,13) then payment_amount*-1 else payment_amount end payment_amount
,payment_time
,a.create_time
,b.area_code
,b.platform
,case when c.source_no  is null or c.source_no='' then b.platform else c.source_no end as source_no 
 from (

		select * from decorate_order_pay dop left JOIN 
		(
		select aa.orders_no as orders_no_1,bb.first_orders_no from decorate_order aa left join (select user_id
		,case when create_time = min(create_time) then orders_no else orders_no end first_orders_no
		 from decorate_order 
		-- where id <= 10
		group by user_id ) bb on aa.user_id = bb.user_id 
		) y on dop.orders_no = y.orders_no_1

) a 
left JOIN decorate_order b on a.first_orders_no = b.orders_no 
left join decorate_order_source c on a.first_orders_no = c.orders_no 
*/

-- 20190107 shg - 修改，更改区域，原先为每个订单的首次渠道的区域编码，现在是每个订单的区域
select a.id 
,a.orders_no
,a.first_orders_no
,a.company
,payment_category
,case when payment_category in (6,7,11,13) then payment_amount*-1 else payment_amount end payment_amount -- 新增13 信用卡退款
,payment_time
,a.create_time
-- ,b.area_code
,a.area_code_1 as area_code
,b.platform
,case when c.source_no  is null or c.source_no='' then b.platform else c.source_no end as source_no 
 from (

		select * from decorate_order_pay dop 
			left JOIN (select aa.orders_no as orders_no_1,bb.first_orders_no from decorate_order aa 
										left join (select user_id,case when create_time = min(create_time) then orders_no else orders_no end first_orders_no from decorate_order 
																-- where id<=10
																	group by user_id ) bb 
										on aa.user_id = bb.user_id 
									) y 
			on dop.orders_no = y.orders_no_1
			LEFT JOIN (select orders_no as orders_no_2,area_code as area_code_1 from decorate_order ) z -- 修改，更改区域，原先为每个订单的首次渠道的区域编码，现在是每个订单的区域
			on dop.orders_no = z.orders_no_2
			) a 
left JOIN decorate_order b on a.first_orders_no = b.orders_no 
left join decorate_order_source c on a.first_orders_no = c.orders_no 


```
### 61011
通话记录表  Fact_Decorate_Order_Check_Holly_Call_Record
``` sql
select -- id
-- ,call_sheet_id-- '通话记录的ID',
call_id-- '通话ID',
,end-begin as call_length  -- 通话时长 单位 秒
,case  when state ='dealing' then 1 else 0 end as call_turn_on_state  -- 是否接通  1是 0 否
-- ,case  when  state = 'leak' then 0 else 1 end as call_state  -- 是否外呼 1是 0 否
,call_type-- '呼叫类型包括： normal普通来电，dialout外呼通话，transfer转接电话，dialtransfer外呼转接',
,call_no-- '主叫号码',
,called_no-- '被叫号码',
,ring-- '开始呼叫时间',
,ringing_time-- '响铃时间',
,begin -- '摘机接通时间',
,end -- '通话结束时间',
-- ,queue_time-- '呼入来电进入技能组时间',
-- ,queue-- '呼入来电进入的技能组',
,agent-- '座席登录名',
,exten-- ,
,state-- '通话记录状态：已接听[dealing]，振铃未接听[notDeal]，已留言[voicemail]，黑名单[blackList]，排队放弃[queueLeak]，ivr [leak]',
-- ,monitor_filename-- '录音文件链接地址',
-- ,record_file-- '通话录音文件名',
,pbx-- '账户所在的PBX',
,agent_name-- '座席姓名',
,call_state-- '事件状态：Ring, Ringing, Link, Hangup(Unlink也当成Hangup处理)',
,province-- '省份',
,district-- '市区',
-- ,ivrkey-- 'ivr按键值',
-- ,survey_content-- '满意度调查按键',
from decorate_order_check_holly_call_record 
-- where agent = 8021
``` 

### 61001
日期 Dim_Time
``` sql
select '2012-01-01' as Date
```

### 61002
推广渠道 Dim_Promotion_Source
已弃用，使用第三方数据抽取进行

### 61003
用户信息 Dim_User_Info
``` sql
select user_id , name from user_info;

```
### 61004
订单状态 Dim_Order_State
``` sql
SELECT
order_states -- 合同状态编码
,interior_name -- 对内显示名称
,outside_name -- 对外显示名称
,state -- '是否可用状态 0 可用 1 不可用',
FROM decorate_order_state


```
### 61005
区域 Dim_Area
``` sql
/*select area_code 
,REPLACE(group_name,'默认组','') group_name 
,REPLACE(group_name,'体验店默认组','') city 
,case  when group_name in ('北京体验店默认组','上海体验店默认组','广州体验店默认组','深圳体验店默认组') then '第一方面军' else
			case when group_name in ('郑州体验店默认组','西安体验店默认组','成都体验店默认组','天津体验店默认组') then '第二方面军' else 
						case when group_name in ('苏州体验店默认组','武汉体验店默认组','重庆体验店默认组','杭州体验店默认组') then '第三方面军' else 
										case when group_name in ('廊坊体验店默认组','昆明体验店默认组','哈尔滨体验店默认组','南京体验店默认组','济南体验店默认组','南昌体验店默认组','太原体验店默认组') then '第四方面军' else 
										'其他方面军' end
						end
		end
 end front_name		
 from im_default_group;
-- 20190107 划分更新 */

select area_code 
,REPLACE(group_name,'默认组','') group_name 
,REPLACE(group_name,'体验店默认组','') city 
,case  when group_name in ('北京体验店默认组','上海体验店默认组','广州体验店默认组','深圳体验店默认组') then '第一方面军' else
			case when group_name in ('廊坊体验店默认组','苏州体验店默认组','武汉体验店默认组','郑州体验店默认组','西安体验店默认组','成都体验店默认组','天津体验店默认组') then '第二方面军' else 
								case when group_name in ('重庆体验店默认组','杭州体验店默认组','昆明体验店默认组','哈尔滨体验店默认组','南京体验店默认组','济南体验店默认组','南昌体验店默认组','太原体验店默认组') then '第三方面军' else 
								'其他方面军' end
		end
 end front_name		
 from im_default_group;

```
执行ETL后事件
``` sql
INSERT INTO [Dim_Area] VALUES ('888', 'mini体验店', '北京', '其他方面军');
-- 20181213 增加，源表中没有 888 的信息
``` 
### 61006
房屋区域表 Dim_house_region
``` sql
select 
id
,name
,region_type
,parent_id
,code
,full_name
,state
from region;
```
### 61007
房屋属性（现房期房）Dim_house_prop
``` sql
select '1'  as code , '现房' as name union all
select '2'  as code , '预测房' as name union all
select '3'  as code , '期房' as name 
```
### 61008
新老房 Dim_House_Decorate_State
``` sql
select '0'  as code , '新房' as name union all
select '1'  as code , '旧房' as name 
```
### 61010
platform平台维度表Dim_Platform 
``` sql
select 
a.name platform
,a.code platform_code
,b.name parent_platform
,b.code parent_platform_code
-- ,a.qtype -- '0代表线下1代表官网3代表第三方渠道',
from qudao a inner join qudao b on a.parent_code =b.code
where a.level = 2
order by b.code
```

## 02采购物流分析
### 70001
采购订单表Fact_Purchase_Order
``` sql
select 
a.id--  ID'
,a.purchase_order_no--  采购单单号',
,a.create_type--  1' COMMENT '创建方式:1:手工创建2:补货创建3:快捷建单',
,a.platform_id--  0' COMMENT '下单平台:1.采购系统2.管家系统 3.发货清单',
,a.order_type--  ' COMMENT '单据类型:PO01(区域外采订单);PO02(区域外采退货订单);PO11(城市外采订单);PO12(城市外采退货订单);TO01(区域调拨订单);TO11(城市调拨订单);TO21(城市内采订单);TO22(城市内采退货订单);',
,a.order_type2--  采购单二级分类(特单使用)',
,a.trans_type--  0' COMMENT '物流方式(10:供应商送货到仓,20:我方自提到仓,30:三方自提到仓,40:供应商送货到工地,50:供应商自提,60:第三方物流至供应商,70:供应商工地自提,80:第三方从工地至供应商)',
-- ,a.create_user--  ' COMMENT '创建人',
,DATE(A.create_time)  create_date -- 订单创建时间 cc：拆分时间和日期
,STR_TO_DATE( CONCAT('2000-01-01',time(A.create_time)) ,'%Y-%m-%d %H:%i:%s')  create_time-- 订单创建时间 cc：拆分时间和日期
-- ,a.create_time--  创建时间',
-- ,a.update_user--  更新人',
,a.update_time--  更新时间',
,a.supplier_no--  ' COMMENT '供应商编号',
-- ,a.supplier_contact--  ' COMMENT '供应商联系人',
-- ,a.source_company_no--  ' COMMENT '发出方公司编码',
,a.source_warehouse_no--  ' COMMENT '发出方仓库编号',
-- ,a.source_location_no--  ' COMMENT '发出方库存地点编码',
-- ,a.source_purchase_manager--  ' COMMENT '发出方采购经理',
-- ,a.source_purchase_manager_phone--  ' COMMENT '发出方采购经理联系电话',
-- ,a.source_warehouse_person--  ' COMMENT '发出方库房人员',
-- ,a.source_warehouse_phone--  ' COMMENT '发出方库房电话',
-- ,a.source_warehouse_address--  ' COMMENT '发出方收货地址',
,a.source_real_warehouse_no--  ' COMMENT '发出方物理仓编号',
,a.source_total_money--  0.00000' COMMENT '发出方采购含税总金额',
,a.source_purchase_tax_no--  ' COMMENT '发出方进项税代码',
-- ,a.dist_company_no--  ' COMMENT '目的方公司编码',
,a.dist_warehouse_no--  ' COMMENT '目的方仓库编号',
-- ,a.dist_location_no--  ' COMMENT '目的仓库存地点',
-- ,a.dist_purchase_manager--  ' COMMENT '目的仓采购经理',
-- ,a.dist_purchase_manager_phone--  ' COMMENT '目的仓采购经理手机号',
-- ,a.dist_warehouse_person--  ' COMMENT '目的仓仓库联系人',
-- ,a.dist_warehouse_phone--  ' COMMENT '目的仓库联系电话',
-- ,a.dist_warehouse_address--  ' COMMENT '目的仓库地址',
,a.dist_real_warehouse_no--  ' COMMENT '目的物理仓编号',
,a.dist_total_money--  0.00000' COMMENT '目的仓采购总金额',
,a.dist_purchase_tax_no--  ' COMMENT '目标方进项税税码',
,a.supplier_confirm_time--  供应商确认订单日期',
,a.receive_time--  实际交货日期',
,a.plan_receive_time--  预计交货日期',
,a.install_time--  安装日期',
,a.delivery_day--  物流送货天数',
,a.delivery_time--  物流送货日期',
,a.note--  ' COMMENT '备注',
,a.state--  0' COMMENT '采购单状态:A01	草稿，A02	撤回，B01	一审待审，B02	二审待审，B03	三审待审，B04	四审待审,B11	审核驳回,C01	供应商待确认,C11	供应商待预约,C12	仓库待确认预约,C21	仓库待发货,C31	供应商待确认收货,C41	仓库待收货,C50	供应商已收货,C60	仓库已收货,C61	仓库部分收货,C05	待供应商发货,C70	工地已收货,D01	废止,D99	删除',
,a.supplier_plan_time--  供应商预约日期',
,a.warehouse_confirm_time--  仓库确认日期',
,a.warehouse_confirm_man--  仓库确认人',
,a.audit_time--  最终审核时间',
,a.sale_goods_order_no--  ' COMMENT '销售订单单号',
,a.sale_type--  配套销售使用：11元sku 2全款需要测量 3全款不需要测量',
,a.sale_contract_no--  ' COMMENT '客户装修合同编号',
-- ,a.sale_customer_mobile--  ' COMMENT '客户手机号',
-- ,a.sale_customer_name--  ' COMMENT '客户姓名',
-- ,a.sale_customer_address--  ' COMMENT '客户地址',
-- ,a.sale_earnest_money--  0.00' COMMENT '定金',
-- ,a.sale_plan_delivery_day--  预约送货时间',
-- ,a.sale_plan_install_day--  预约安装时间',
-- ,a.sale_plan_measure_time--  预约测量时间',
-- ,a.sale_real_measure_time--  实际测量时间',
-- ,a.sale_report_install_time--  提报安装时间',
-- ,a.sale_measure_note--  ' COMMENT '测量备注', 
,count(b.id) as count_pod -- 采购单sku个数
from scm.purchase_order a left join scm.purchase_order_detail b on a.purchase_order_no = b.purchase_order_no
group by a.id 
``` 
### 70002
采购订单明细表 Fact_Purchase_Order_Detail
``` sql
select 
a.id-- int(10) NOT NULL AUTO_INCREMENT,a. 
,a.purchase_order_no-- '采购单单号',a. 
-- ,a.supplier_goods_no-- '供应商商品编号',a. 
,a.goods_no-- '商品编码',a. 
-- ,a.goods_name-- '商品名称【冗余】',a. 
-- ,a.goods_level-- '1' COMMENT '商品层级:1:独立sku或子sku,a.2:母sku,a.改版后只有子sku,a.合并sku',a. 
,a.line_num-- '0' COMMENT '行号',a. 
,a.expect_num-- ,a.4采购建议数量',a. 
,a.stock_num-- '0.00' COMMENT '可退、可调拨，可采购数量',a. 
,a.purchase_unit-- '采购单位',a.   					-- 20181229 目前都是按基本单位
,a.purchase_unit_num-- ,a.4采购单位数量',a.  -- 20181229 目前都是按基本单位
,a.gift_num-- ,a.4赠品数量',a. 
,a.real_num-- ,a.4实际数量',a. 
,a.base_unit-- '基本计量单位',a. 
,a.base_unit_num-- ,a.4基本单位数量',a. 
,a.numerator-- '采购单位到基本单位的转换分子',a. 
,a.denominator-- '采购单位到基本单位的转换分母',a. 
,a.source_purchase_price-- ,a.4发出方采购单位下含税单价',a. 
,a.source_total_amount-- '发出方采购含税总金额',a. 
,a.source_purchase_tax_no-- '发出方进项税代码',a. 
,a.dist_purchase_price-- ,a.4目标方采购含税单价',a. 
,a.dist_total_amount-- '目标方采购含税总金额',a. 
,a.dist_purchase_tax_no-- '目标方进项税税码',a. 
,a.supply_price-- ,a.4供货价',a. 
,a.supply_total_amount-- '供货总价',a. 
,a.supply_tax_no-- '销项税',a. 
,a.specification-- 规格型号颜色',a. 
-- ,a.note-- 备注',a. 
-- ,a.update_user-- '更新人',a. 
,a.update_time-- '更新时间',a. 
,a.total_receive_num-- ,a.4已收数量',a. 
,a.produce_code-- 50生产码',a. 
,a.produce_name-- 生产名称',a. 
-- ,a.goods_space-- '空间',a.  


,b.create_type--  1' COMMENT '创建方式:1:手工创建2:补货创建3:快捷建单',
,b.platform_id--  0' COMMENT '下单平台:1.采购系统2.管家系统 3.发货清单',
,b.order_type--  ' COMMENT '单据类型:PO01(区域外采订单);PO02(区域外采退货订单);PO11(城市外采订单);PO12(城市外采退货订单);TO01(区域调拨订单);TO11(城市调拨订单);TO21(城市内采订单);TO22(城市内采退货订单);',
,b.order_type2--  采购单二级分类(特单使用)',
,b.trans_type--  0' COMMENT '物流方式(10:供应商送货到仓,20:我方自提到仓,30:三方自提到仓,40:供应商送货到工地,50:供应商自提,60:第三方物流至供应商,70:供应商工地自提,80:第三方从工地至供应商)',
,DATE(b.create_time)  create_date -- 订单创建时间 cc：拆分时间和日期
,STR_TO_DATE( CONCAT('2000-01-01',time(b.create_time)) ,'%Y-%m-%d %H:%i:%s')  create_time-- 订单创建时间 cc：拆分时间和日期
-- ,b.update_time--  更新时间',
,b.supplier_no--  ' COMMENT '供应商编号',
,b.source_warehouse_no--  ' COMMENT '发出方仓库编号',
,b.source_real_warehouse_no--  ' COMMENT '发出方物理仓编号',
,b.source_total_money--  0.00000' COMMENT '发出方采购含税总金额',
-- ,b.source_purchase_tax_no--  ' COMMENT '发出方进项税代码',
,b.dist_warehouse_no--  ' COMMENT '目的方仓库编号',
,b.dist_real_warehouse_no--  ' COMMENT '目的物理仓编号',
,b.dist_total_money--  0.00000' COMMENT '目的仓采购总金额',
-- ,b.dist_purchase_tax_no--  ' COMMENT '目标方进项税税码',
,b.supplier_confirm_time--  供应商确认订单日期',
,b.receive_time--  实际交货日期',
,b.plan_receive_time--  预计交货日期',
,b.install_time--  安装日期',
,b.delivery_day--  物流送货天数',
,b.delivery_time--  物流送货日期',
-- ,b.note--  ' COMMENT '备注',
,b.state--  0' COMMENT '采购单状态:A01	草稿，A02	撤回，B01	一审待审，B02	二审待审，B03	三审待审，B04	四审待审,B11	审核驳回,C01	供应商待确认,C11	供应商待预约,C12	仓库待确认预约,C21	仓库待发货,C31	供应商待确认收货,C41	仓库待收货,C50	供应商已收货,C60	仓库已收货,C61	仓库部分收货,C05	待供应商发货,C70	工地已收货,D01	废止,D99	删除',
,b.supplier_plan_time--  供应商预约日期',
,b.warehouse_confirm_time--  仓库确认日期',
-- ,b.warehouse_confirm_man--  仓库确认人',
,b.audit_time--  最终审核时间',


from scm.purchase_order_detail a left join  scm.purchase_order b on a.purchase_order_no = b.purchase_order_no 
-- where a.purchase_order_no = 'PO10000026'
```
### 70003
商品凭证头表 Fact_Goods_Voucher
``` sql
select id
,goods_voucher_no   --  商品凭证编号',
,order_no   --  业务单号',
,voucher_type   --   凭证类型\nWE:收货\nWI:盘点\nWL:发货',
,voucher_time   --   凭证日期',
,finace_time   --   过账日期',
,buss_company_no   --   业务发生公司编码(结算公司)',
,customer_archives_no   --  客户档案编号',
,create_time   --   创建时间',
,create_user   --   创建人[usnam]',
,wms   --   wms凭证号',
,dist_company_no   --  目标公司编号(指内采单实际由那个分公司下单,内采单专用字段)',
,move_type   --  移动类型',
,buss_no_tax_amount   --   0.00' COMMENT '凭证明细汇总金额',
,buss_tax_no   --  税号',
,supplier_no   --  供应商编号',
from goods_voucher
```
### 70004
商品凭证明细表 Fact_Goods_Voucher_Detail
``` sql


select
id
,goods_voucher_no   --  商品凭证编号',
,seq_no   --   序号',
,line_no   --   凭证行号',
,virtual_type   --   0' COMMENT '是否虚拟：0-否  1-是',
,move_type   --  移动类型\n',
,order_no   --  直接关联单据编号',
,relate_order_no   --  关联单据编号',
,buss_company_no   --   业务发生公司编码',
,buss_logic_warehouse_no   --  业务发生逻辑仓编号',
,buss_real_warehouse_no   --  业务发生物理仓编号',
,buss_location_no   --  业务发生方库存地点编号',
,goods_no   --   商品编号',
,base_unit   --   基本计量单位',
,num   --   0.00' COMMENT '基本单位数量',
,buss_in_out   --  业务发生方出入库标识:-:出,+:入,X:不出不入',
,supplier_no   --   供应商编号',
,buss_no_tax_price   --   0.00000000' COMMENT '业务发生方基本单位不含税单价',
,buss_no_tax_amount   --   0.00' COMMENT '业务方不含税总金额',
,buss_tax_no   --  业务发生方税代码',
,output_tax_no   --  销项税 ',
,contract_no   --  合同编号',
,produce_code   --  生产码',
,produce_name   --  生产名称',
,voucher_time   --   凭证日期',
,finace_time   --   过账时间',
,note   --   备注',
,state   --   0' COMMENT '状态 0 待同步 1 已同步',
from goods_voucher_detail 
-- where id = '3880362';
```
### 70005
日库存备份表 Fact_Stock_Day_History
``` sql
select 
id -- id',
,stock_id
,company_no --  '分公司编码',
,logic_warehouse_no --  '逻辑仓库编号',
,goods_no --  '商品编码',
,cost -- 0.00000000 '库存成本价',
,total_cost -- 0.00 '库存总金额',
,base_unit --  '基本单位',
,total_num -- 0.00 '库存总数量',
,case when create_time   = '0000-00-00 00:00:00' then  update_time else create_time end as create_time -- 创建时间', -- 将创建时间为0的更新为更新时间，
,case when update_time   = '0000-00-00 00:00:00' then  create_time else update_time end as update_time -- 更新时间', -- 将更新时间为0的更新为创建时间，
,bak_time -- 备份日期',
from stock_day_history   -- 库存备份表
-- where id = '1383163'
```
### 70006
日库存明细备份表Fact_Stock_Day_History_Detail
``` sql

select id -- id',
,stock_id -- stock_id',
,logic_warehouse_no --  '逻辑仓库编号',
,goods_no --  '商品编码',
,location_no --  '库存地点',
,stock_num -- 0.00000000 '库存数量',
,base_unit --  '基本单位',
,case when create_time   = '0000-00-00 00:00:00' then  update_time else create_time end as create_time -- 创建时间', -- 将创建时间为0的更新为更新时间，
,case when update_time   = '0000-00-00 00:00:00' then  create_time else update_time end as update_time -- 更新时间', -- 将更新时间为0的更新为创建时间，
,stock_type --  '库存类型:10:常规库存,20:订单库存',
,contract_no --  '合同编号',
-- ,price
-- ,total_money
-- ,company_no
,bak_date -- 备份日期',
,produce_code
from stock_day_history_detail -- 日库存明细备份表
-- where id = '1688424'
```
### 70007
库存周转明细表 Fact_Stock_Day_Detail_Tran
``` sql
select 
 DATE_ADD(date(now()) ,INTERVAL -1 day) as bak_date
,a.logic_warehouse_no
,a.goods_no
,case when a_90.total_num is not null then 0 else 1 end as is_new -- 是否新品 0：否  1：是
,b.total_num as start_total_num_7
,b.total_cost as start_total_cost_7
,case when a_30.total_num is null then 0 else a_30.total_num end as start_total_num_30
,case when a_30.total_cost is null then 0 else a_30.total_cost end as start_total_cost_30
,case when a_90.total_num is null then 0 else a_90.total_num end as start_total_num_90
,case when a_90.total_cost is null then 0 else a_90.total_cost end as start_total_cost_90
,case when a.total_num is null then 0 else a.total_num end  as end_total_num
,case when a.total_cost is null then 0 else a.total_cost end  as end_total_cost

,case when d.in_num is null then 0 else d.in_num end as in_num_7
,case when d.buss_no_tax_amount is null then 0 else d.buss_no_tax_amount end as in_buss_no_tax_amount_7

,case when c.out_num is null then 0 else c.out_num end as out_num_7
,case when c.buss_no_tax_amount is null then 0 else c.buss_no_tax_amount end as out_buss_no_tax_amount_7

,case when d_30.in_num is null then 0 else d_30.in_num end as in_num_30
,case when d_30.buss_no_tax_amount is null then 0 else d_30.buss_no_tax_amount end as in_buss_no_tax_amount_30

,case when c_30.out_num is null then 0 else c_30.out_num end as out_num_30
,case when c_30.buss_no_tax_amount is null then 0 else c_30.buss_no_tax_amount end as out_buss_no_tax_amount_30

,case when d_90.in_num is null then 0 else d_90.in_num end as in_num_90
,case when d_90.buss_no_tax_amount is null then 0 else d_90.buss_no_tax_amount end as in_buss_no_tax_amount_90

,case when c_90.out_num is null then 0 else c_90.out_num end as out_num_90
,case when c_90.buss_no_tax_amount is null then 0 else c_90.buss_no_tax_amount end as out_buss_no_tax_amount_90
from (
		-- 期末仓库余量
		select 
		* from stock_day_history
		where 
		 bak_time  = DATE_ADD(date(now()) ,INTERVAL -1 day)
		group by logic_warehouse_no,goods_no
) a
LEFT JOIN 
		(
		-- 期初仓库余量
				select 
		* from stock_day_history
		where 
		 bak_time  = DATE_ADD(date(now()) ,INTERVAL -8 day)
		group by logic_warehouse_no,goods_no
) b 
on a.logic_warehouse_no=b.logic_warehouse_no and a.goods_no = b.goods_no
 -- 以下为30天的库存
LEFT JOIN 
		(
		-- 期初仓库余量
				select 
		* from stock_day_history
		where 
		 bak_time  = DATE_ADD(date(now()) ,INTERVAL -31 day)
		group by logic_warehouse_no,goods_no
) a_30
on a.logic_warehouse_no=a_30.logic_warehouse_no and a.goods_no = a_30.goods_no
LEFT JOIN 
		(
		-- 期初仓库余量
				select 
		* from stock_day_history
		where 
		 bak_time  = DATE_ADD(date(now()) ,INTERVAL -91 day)
		group by logic_warehouse_no,goods_no
) a_90
on a.logic_warehouse_no=a_90.logic_warehouse_no and a.goods_no = a_90.goods_no



 -- 以下为7天出入库数量
LEFT JOIN 
(
		-- 区间时间内出库数量
		SELECT -- min(gv.create_time) 
		gvd.buss_logic_warehouse_no
		,gvd.goods_no
		,sum(gvd.num) as out_num
		
		,gvd.buss_no_tax_amount
		FROM
			goods_voucher_detail gvd
		LEFT JOIN goods_voucher gv ON gvd.goods_voucher_no = gv.goods_voucher_no
		WHERE
			gv.create_time BETWEEN DATE_ADD(date(now()) ,INTERVAL -8 day) and DATE_ADD(date(now()) ,INTERVAL -1 day)  -- 当前日期到三十天前之间
		and gvd.buss_in_out = '-'
		group by gvd.buss_logic_warehouse_no,gvd.goods_no
) c
on a.logic_warehouse_no=c.buss_logic_warehouse_no and a.goods_no = c.goods_no
LEFT JOIN 
(
		-- 区间时间内入库数量
		SELECT -- min(gv.create_time) 
		gvd.buss_logic_warehouse_no
		,gvd.goods_no
		,sum(gvd.num) as in_num
		
		,gvd.buss_no_tax_amount
		FROM
			goods_voucher_detail gvd
		LEFT JOIN goods_voucher gv ON gvd.goods_voucher_no = gv.goods_voucher_no
		WHERE
			gv.create_time BETWEEN DATE_ADD(date(now()) ,INTERVAL -8 day) and DATE_ADD(date(now()) ,INTERVAL -1 day)  -- 当前日期到三十天前之间
		and gvd.buss_in_out = '+'
		group by gvd.buss_logic_warehouse_no,gvd.goods_no
) d
on a.logic_warehouse_no=d.buss_logic_warehouse_no and a.goods_no = d.goods_no


 -- 以下为30天出入库数量
LEFT JOIN 
(
		-- 区间时间内出库数量
		SELECT -- min(gv.create_time) 
		gvd.buss_logic_warehouse_no
		,gvd.goods_no
		,sum(gvd.num) as out_num
		
		,gvd.buss_no_tax_amount
		FROM
			goods_voucher_detail gvd
		LEFT JOIN goods_voucher gv ON gvd.goods_voucher_no = gv.goods_voucher_no
		WHERE
			gv.create_time BETWEEN DATE_ADD(date(now()) ,INTERVAL -31 day) and DATE_ADD(date(now()) ,INTERVAL -1 day)  -- 当前日期到三十天前之间
		and gvd.buss_in_out = '-'
		group by gvd.buss_logic_warehouse_no,gvd.goods_no
) c_30
on a.logic_warehouse_no=c_30.buss_logic_warehouse_no and a.goods_no = c_30.goods_no
LEFT JOIN 
(
		-- 区间时间内入库数量
		SELECT -- min(gv.create_time) 
		gvd.buss_logic_warehouse_no
		,gvd.goods_no
		,sum(gvd.num) as in_num
		
		,gvd.buss_no_tax_amount
		FROM
			goods_voucher_detail gvd
		LEFT JOIN goods_voucher gv ON gvd.goods_voucher_no = gv.goods_voucher_no
		WHERE
			gv.create_time BETWEEN DATE_ADD(date(now()) ,INTERVAL -31 day) and DATE_ADD(date(now()) ,INTERVAL -1 day)  -- 当前日期到三十天前之间
		and gvd.buss_in_out = '+'
		group by gvd.buss_logic_warehouse_no,gvd.goods_no
) d_30
on a.logic_warehouse_no=d_30.buss_logic_warehouse_no and a.goods_no = d_30.goods_no


 
 -- 以下为30天出入库数量
LEFT JOIN 
(
		-- 区间时间内出库数量
		SELECT -- min(gv.create_time) 
		gvd.buss_logic_warehouse_no
		,gvd.goods_no
		,sum(gvd.num) as out_num
		
		,gvd.buss_no_tax_amount
		FROM
			goods_voucher_detail gvd
		LEFT JOIN goods_voucher gv ON gvd.goods_voucher_no = gv.goods_voucher_no
		WHERE
			gv.create_time BETWEEN DATE_ADD(date(now()) ,INTERVAL -91 day) and DATE_ADD(date(now()) ,INTERVAL -1 day)  -- 当前日期到三十天前之间
		and gvd.buss_in_out = '-'
		group by gvd.buss_logic_warehouse_no,gvd.goods_no
) c_90
on a.logic_warehouse_no=c_90.buss_logic_warehouse_no and a.goods_no = c_90.goods_no
LEFT JOIN 
(
		-- 区间时间内入库数量
		SELECT -- min(gv.create_time) 
		gvd.buss_logic_warehouse_no
		,gvd.goods_no
		,sum(gvd.num) as in_num
		
		,gvd.buss_no_tax_amount
		FROM
			goods_voucher_detail gvd
		LEFT JOIN goods_voucher gv ON gvd.goods_voucher_no = gv.goods_voucher_no
		WHERE
			gv.create_time BETWEEN DATE_ADD(date(now()) ,INTERVAL -91 day) and DATE_ADD(date(now()) ,INTERVAL -1 day)  -- 当前日期到三十天前之间
		and gvd.buss_in_out = '+'
		group by gvd.buss_logic_warehouse_no,gvd.goods_no
) d_90
on a.logic_warehouse_no=d_90.buss_logic_warehouse_no and a.goods_no = d_90.goods_no
```
执行ETL后事件
```
-- 将周转库存日表中的数据插入到周转库存明细表中
INSERT INTO Fact_Stock_Day_Detail SELECT
	*
FROM
	Fact_Stock_Day_Detail_Tran

-- 删除临时表
IF EXISTS (	SELECT		*	FROM		tempdb..sysobjects	WHERE		name LIKE '#T5%') DROP TABLE #T5

-- 将 周转库存明细表 的去重数据插入到临时表中
SELECT DISTINCT
	* INTO #T5
FROM
	Fact_Stock_Day_Detail
	
	-- 删除 周转库存明细表
DROP TABLE Fact_Stock_Day_Detail

-- 将去重数据重新插入到周转库存明细表中
SELECT 
*
INTO  Fact_Stock_Day_Detail
FROM #T5

```
### 70201
商品表 Dim_02_Goods
``` sql
select id 
,goods_no  --  ' COMMENT '商品编码',
,goods_name  --  ' COMMENT '商品名称',
,goods_type  --  0' COMMENT '商品类别:1:单一商品,2:A类母SKU,3：B类母SKU',
,category_no  --  ' COMMENT '分类编码',
,brand_no  --  品牌编码',
,goods_parent_no  --  ' COMMENT '父商品编码',
,goods_level  --  0' COMMENT '商品层级:1:独立sku或子sku,2:母sku',
,goods_style  --  0' COMMENT '商品类型[1:经销,2:代销]',
,goods_model  --  ' COMMENT '商品型号',
,goods_color  --  ' COMMENT '商品颜色',
,goods_enable_days  --  0' COMMENT '保质期（天）',
,goods_carton  --  ' COMMENT '箱规',
,goods_is_show_price  --  0' COMMENT '报价显示【1：显示，2：不显示】',
,goods_manage_type  --  0' COMMENT '管理类别[1主材、2辅材、3木作]',
,goods_work_type  --  ' COMMENT '适用工种【1:水工施工、2电工施工、3木工施工、4瓦工施工、5油工施工，99：其他 与数据字典保持一致】',
,goods_package_ratio  --  1' COMMENT '包装率',
,goods_state  --  0' COMMENT '暂不用，商品状态【1：正常，2：冻结，9：删除】参照StateEnum',
,create_id  --  创建人id',
,create_time  --  创建日期',
,create_user  --  ' COMMENT '创建人姓名',
,update_id  --  更新人id',
,update_time  --  变更日期',
,update_user  --  ' COMMENT '更新人姓名',
,category_sale_no  --  前台分类编码',
,element_type  --  子商品部件类型【1：普通，2：部件，3：组件】',
,is_ele  --  0' COMMENT '是否定制商品【0否，1是】',
,tax_type_no  --  ' COMMENT '税分类代码',
,is_measured  --  0' COMMENT '是否测量【0否，1是】',
from goods.goods
``` 
### 70202
商品类别表Dim_02_Goods_Category
``` sql
select  a.category_name 
,a.category_no 
,a.parent_no  

,a.property -- 套餐属性【1新房、2老房、3MINI】（限定999套餐分类）',
,a.state -- 状态 1正常 2冻结

,b.category_name as category_name_1
,b.category_no as category_no_1
,b.parent_no  as parent_no_1
,c.category_name as category_name_2
,c.category_no as category_no_2
,c.parent_no  as parent_no_2
,d.category_name as category_name_3
,d.category_no as category_no_3
,d.parent_no  as parent_no_3
,e.category_name as category_name_4
,e.category_no as category_no_4
,e.parent_no as parent_no_4
from goods.goods_category a LEFT JOIN goods.goods_category b  
on a.parent_no  = b.category_no  
LEFT JOIN goods.goods_category c 
on b.parent_no  = c.category_no  
LEFT JOIN goods.goods_category d 
on c.parent_no  = d.category_no  
LEFT JOIN goods.goods_category e 
on d.parent_no  = e.category_no  
where a.`level` = 4; 
```
### 70203
商品品牌表 Dim_02_Goods_Brand
``` sql 
select
id
,brand_name -- 品类名称
,brand_no-- '品牌编码',
,brand_type-- 品类类型',
,brand_state
from goods.goods_brand
```
### 70204
物理仓表 Dim_02_Warehouse
``` sql
select id
,real_warehouse_no -- 仓库编号
,name  as real_warehouse_name -- 仓库名
,state -- '仓库状态1:正常,2:失效', 

from base.warehouse
```
###  70205
逻辑仓表 Dim_02_Logic_Warehouse
``` sql
select id
,logic_warehouse_no  --  ' COMMENT '逻辑仓编码',
,store_no  --  ' COMMENT '公司编号',
,name as logic_warehouse_name --  仓库名称',
,type  --  1' COMMENT '仓库类型:1:RDC,2:DC',
,logic_type  --  1' COMMENT '逻辑仓类型:1:逻辑仓,2:门店',
,state  --  1' COMMENT '仓库状态',
,note  --  备注',
,is_default  --  0' COMMENT '是否分公司默认仓库',
from base.logic_warehouse
```
### 70206
供应商表 Dim_02_Supplier
``` sql
select id  --  supplier_id',
,supplier_no  --  ' COMMENT '供货商编码',
,supplier_name  --  ' COMMENT '供货商名称',
,telphone  --  ' COMMENT '负责人电话',
,contact  --  ' COMMENT '负责人',
,email  --  ' COMMENT '邮箱',
,run_type  --  0' COMMENT '经营属性  0:经销  1:代销  2：虚拟',
,grade  --  0' COMMENT '供应商评级 1.A 2.B 3.C 4.D',
,tax_no  --  ' COMMENT '进项税码',
,office_addr  --  ' COMMENT '供应商办公地址',
,store_addr  --  ' COMMENT '供应商仓库地址',
,level  --  0' COMMENT '级别【1全国/2区域/3城市】',
,property  --  0' COMMENT '属性【1生产商、2代理商、3经销商】',
,state  --  0' COMMENT '状态 1:正常 2:冻结  3：清户',
,bank  --  开户行',
,bank_account  --  银行账号',
,create_id  --  0' COMMENT '创建人id',
,create_time  --  创建时间',
,create_name  --  ' COMMENT '创建人姓名',
,update_id  --  0' COMMENT '更新人id',
,update_time  --  更新时间',
,update_name  --  ' COMMENT '更新人名称',
from goods.supplier
```
### 70207
采购单状态表Dim_02_Purchase_Order_State
``` sql
select 'A01' as code ,'草稿'              as name union all 
select 'A02' as code ,'撤回'              as name union all 
select 'B01' as code ,'一审待审'          as name union all 
select 'B02' as code ,'二审待审'          as name union all 
select 'B03' as code ,'三审待审'          as name union all 
select 'B04' as code ,'四审待审'          as name union all 
select 'B11' as code ,'审核驳回'          as name union all 
select 'C01' as code ,'供应商待确认'      as name union all 
select 'C11' as code ,'供应商待预约'      as name union all 
select 'C12' as code ,'仓库待确认预约'    as name union all 
select 'C21' as code ,'仓库待发货'        as name union all 
select 'C31' as code ,'供应商待确认收货'  as name union all 
select 'C41' as code ,'仓库待收货'        as name union all 
select 'C50' as code ,'供应商已收货'      as name union all 
select 'C60' as code ,'仓库已收货'        as name union all 
select 'C61' as code ,'仓库部分收货'      as name union all 
select 'C05' as code ,'待供应商发货'      as name union all 
select 'C70' as code ,'工地已收货'        as name union all 
select 'D01' as code ,'废止'              as name union all 
select 'D99' as code ,'删除'
```
### 70208
采购单创建方式表Dim_02_Purchase_Order_Create_Type
``` sql
select '1' as code , '手工创建' as name union all
select '2' as code , '补货创建' as name union all
select '3' as code , '快捷建单' as name

```
### 70209
采购单下单平台表 Dim_02_Purchase_Order_Platform_Id
``` sql
select '0' as code , '默认' as name union all
select '1' as code , '采购系统' as name union all
select '2' as code , '管家系统' as name union all
select '3' as code , '发货清单' as name
```
### 70210
采购单据类型表 Dim_02_Purchase_Order_Type
``` sql

select 'PO01' as code,'区域外采订单' as name union all 
select 'PO02' as code,'区域外采退货订单' as name union all 
select 'PO11' as code,'城市外采订单' as name union all 
select 'PO12' as code,'城市外采退货订单' as name union all 
select 'TO01' as code,'区域调拨订单' as name union all 
select 'TO11' as code,'城市调拨订单' as name union all 
select 'TO21' as code,'城市内采订单' as name union all 
select 'TO22' as code,'城市内采退货订单' 
```
### 70211
采购单物流方式表 Dim_02_Purchase_Order_Tran_Type
``` sql
select ' 0' as code, '默认 ' as name union all
select '10' as code, '供应商送货到仓 ' as name union all
select '20' as code, '我方自提到仓 ' as name union all
select '30' as code, '三方自提到仓 ' as name union all
select '40' as code, '供应商送货到工地 ' as name union all
select '50' as code, '供应商自提 ' as name union all
select '60' as code, '第三方物流至供应商 ' as name union all
select '70' as code, '供应商工地自提 ' as name union all
select '80' as code, '第三方从工地至供应商' as name

```
2019年01月09日 18时53分27秒
``` sql
select 
 sp.id  --   '编号',
,sp.stockout_no  --   '' COMMENT '任务编号',
,case when sp.status = 0 then '已创建' else '调度已下单' end  --  '0' COMMENT '状态(0：已创建3：调度已下单)',
,sp.contract_no  --   '',
,wdob.orders_no -- 合同号
,CONCAT(wdo.order_states,'-',orderStates.name) -- 合同状态
-- ,wdo.order_states -- 合同状态
,wdo.user_name 
,wdob.working_date -- 实际开工日期
,wdob.project_check_date -- 实际竣工日期
,bs.store_name -- 门店名称
-- ,wdob.werks -- 门店编码
,bw.name
-- ,sp.real_warehouse_no  --   '' COMMENT '物理仓编号',
,blw.name  -- 逻辑仓名称
-- ,sp.logic_warehouse_no  --   '' COMMENT '逻辑仓编号',
,bsl.name -- 库存地点
-- ,sp.location_no  --   '' COMMENT '库存地点',
,sp.goods_no  --   '' COMMENT '商品编号',
-- 商品名称
-- 默认供应商
-- 品牌
-- 管理类别
,sp.stockout_quantity  --   '0.00' COMMENT '缺货数量',
,sp.order_no  --   '业务单据号',
,so.send_schedule -- 发货日程
,sp.new_order_no  --   '' COMMENT '新发货单号',
,sp.create_time  --   '创建时间',
,sp.create_user  --   '' COMMENT '创建人',

 from scm.stockout_pool sp 
left JOIN www.decorate_order as wdo on sp.contract_no = wdo.orders_no
left join www.decorate_order_bussiness as wdob on sp.contract_no = wdob.orders_no
left join send_order so on sp.order_no = so.send_order_no
left join (SELECT * FROM base.dictionary_info WHERE dict_code LIKE '%orderStates%' ) orderStates on wdo.order_states = orderStates.code
left join base.store as bs on wdob.werks = bs.store_no 
left join base.logic_warehouse blw on sp.logic_warehouse_no = blw.logic_warehouse_no
left join base.warehouse bw on sp.real_warehouse_no = bw.real_warehouse_no
left join base.storage_location bsl on sp.location_no = bsl.storage_location_no -- 库存地点表
left join base.send_schedule bss on bss.schedule_no = sp.send --  发货日程表

where stockout_no = '901QH19010921967';
```



# Model
