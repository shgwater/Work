---
title: 2018-12-27_01互联网分析
---
# 01互联网营销分析
## ETL 部分备份
2018年12月27日 16时51分02秒
60051 订单
``` sql
select A.id
,A.orders_no  -- 订单号
,DATE(A.create_time) create_date -- 订单创建时间 cc：拆分时间和日期
,STR_TO_DATE( CONCAT('2000-01-01',time(A.create_time)) ,'%Y-%m-%d %H:%i:%s') create_time-- 订单创建时间 cc：拆分时间和日期
,A.platform  -- 平台 pc/M
,A.user_id -- 用户id
,A.user_name -- 用户名称
,A.order_states --  'erp订单状态：10-待付定金，20-待约合开工日期，40-待派单，50-待约合排列日期，51-待分配排雷工人，52-待排雷反馈，60-待设计报价状态，90-待审核报价状态，91-待复核报价状态，150-待签约，155-待审核合同，150-已签约，170-施工中，200-已竣工，300-已过期，400-已退款',
 -- ,shop_no -- 门店编码 -- 无数据
,A.area_code -- 门店区域编码
,A.amount  -- 订单表定金
,A.gender  --  '0：女；1：男',
,A.orders_type -- 订单房屋类型：0新1旧
,A.activity_code -- 活动标识
,A.deposit_pay_sign -- 订金支付标识1:订金小于500大于0,2：订金大于等于500  decorate_order_pay 中的金额
-- 20181206(更新渠道对应方案，渠道编号为空的) ,B.source_no as source_no -- 推广渠道编号
,(case when B.source_no is null or B.source_no='' then A.platform else B.source_no end) as source_no -- 推广渠道编号
-- ,C.doc_order_no -- 订单号
,date(C.doc_first_vaild_date) doc_first_vaild_date -- 首次有效时间
,date(C.doc_plan_enter_store_date) doc_plan_enter_store_date -- 预约进店时间
,date(C.doc_enter_store_date) doc_enter_store_date -- 客户进店日期
,C.doc_first_vaild_user -- 首次首次有效人 20181207 
,C.doc_first_vaild_user_code -- 首次首次有效人编号 20181212  worker 表
,E.customer_manager -- 客户经理姓名 20181212 -- decorate_order_bussiness 应该用这张表的
,E.project_manager -- 项目经理姓名 20181212
,E.designer -- 设计师姓名 20181212
,E.customer_manager_no -- '客户经理编号',20181212
,E.project_manager_no --  '项目经理编号',20181212
,E.designer_no -- '设计师编号',20181212
,C.doc_history_kf_code -- 历史客服编号 20181212
,C.doc_order_repeat -- 重复订单，0否，1是   20181212
,C.doc_invalid_confirm_state  -- 无效确认0否1是 20181212
,C.doc_check_num -- 跟进次数 20181212
,D.un_payment_category -- 退款金额
,D.payment_category-- 回款金额
,date(D.payment_date) payment_date -- 交订时间
,date(D.un_payment_date) un_payment_date -- 退订时间
,case when A.deposit_pay_sign = 2 and  D.payment_date is not null then date(D.payment_date) else null end payment_date_500-- 交订满 500 日期
,case when A.deposit_pay_sign = 2 and  D.un_payment_date is not null then date(D.un_payment_date) else null end un_payment_date_500-- 交订满 500 日期
,date(E.contract_date) contract_date -- 实际签约时间
,F.total_amount -- 合同金额
,G.region_id -- 房屋区域
,G.community -- 小区名称
,G.house_category -- 房屋类别
,G.house_type -- 房屋户型
,G.area -- 房屋面积
,G.measure_area -- 实际测量面积 
,G.house_prop -- 房屋属性
,G.house_decorate_state -- 新老房
,G.building_year -- 建造年份（数据字典）

from decorate_order A
LEFT JOIN decorate_order_source B on A.orders_no = B.orders_no
LEFT JOIN decorate_order_check C on A.orders_no = C.doc_order_no
LEFT JOIN 
(select  orders_no
  ,sum(case when payment_category in (6,7,11) then payment_amount else 0 end)  un_payment_category
	, sum(case when payment_category in (6,7,11) then 0 else payment_amount end) payment_category
  , min(case when payment_category in (6,7,11) then null else payment_time end) payment_date
  , min(case when payment_category in (6,7,11) then null else create_time end) create_payment_date  -- 交订创建时间
  , max(case when payment_category in (6,7,11) then payment_time else null end) un_payment_date
  , max(case when payment_category in (6,7,11) then create_time else null end) create_un_payment_date -- 退订单创建时间
  from decorate_order_pay  -- where orders_no	= 'DD20180823000473'
group by orders_no) D on A.orders_no = D.orders_no
LEFT JOIN decorate_order_bussiness E on A.orders_no = E.orders_no
LEFT JOIN decorate_order_amount F on A.orders_no = F.orders_no
LEFT JOIN decorate_order_house G on A.orders_no = G.order_no
-- where A.orders_no	= 'DD20181119001189';
/* 20181213 update 增加字段
select A.id
,A.orders_no  -- 订单号
,DATE(A.create_time) create_date -- 订单创建时间 cc：拆分时间和日期
,STR_TO_DATE( CONCAT('2000-01-01',time(A.create_time)) ,'%Y-%m-%d %H:%i:%s') create_time-- 订单创建时间 cc：拆分时间和日期
,A.platform  -- 平台 pc/M
,A.user_id -- 用户id
,A.order_states --  'erp订单状态：10-待付定金，20-待约合开工日期，40-待派单，50-待约合排列日期，51-待分配排雷工人，52-待排雷反馈，60-待设计报价状态，90-待审核报价状态，91-待复核报价状态，150-待签约，155-待审核合同，150-已签约，170-施工中，200-已竣工，300-已过期，400-已退款',
 -- ,shop_no -- 门店编码 -- 无数据
,A.area_code -- 门店区域编码
,A.amount  -- 定金
,A.gender  --  '0：女；1：男',
,A.orders_type -- 订单房屋类型：0新1旧
,A.activity_code -- 活动标识
,A.deposit_pay_sign -- 订金支付标识1:订金小于500大于0,2：订金大于等于500
-- 20181206(更新渠道对应方案，渠道编号为空的) ,B.source_no as source_no -- 推广渠道编号
,(case when B.source_no is null or B.source_no='' then A.platform else B.source_no end) as source_no -- 推广渠道编号
-- ,C.doc_order_no -- 订单号
,date(C.doc_first_vaild_date) doc_first_vaild_date -- 首次有效时间
,date(C.doc_plan_enter_store_date) doc_plan_enter_store_date -- 预约进店时间
,date(C.doc_enter_store_date) doc_enter_store_date -- 客户进店日期

,C.doc_first_vaild_user -- 首次首次有效人 20181207 
,D.un_payment_category -- 退订金额
,D.payment_category-- 交订金额
,date(D.payment_date) payment_date -- 交订时间
,date(D.un_payment_date) un_payment_date -- 退订时间
,date(E.contract_date) contract_date -- 实际签约时间
,F.total_amount -- 合同金额
,G.region_id -- 房屋区域
,G.community -- 小区名称
,G.house_category -- 房屋类别
,G.house_type -- 房屋户型
,G.area -- 房屋面积
,G.measure_area -- 实际测量面积 
,G.house_prop -- 房屋属性
,G.house_decorate_state -- 新老房
,G.building_year -- 建造年份（数据字典）

from decorate_order A
LEFT JOIN decorate_order_source B on A.orders_no = B.orders_no
LEFT JOIN decorate_order_check C on A.orders_no = C.doc_order_no
LEFT JOIN 
(select  orders_no, sum(case when payment_category in (6,7,11) then payment_amount else 0 end)  un_payment_category
	, sum(case when payment_category in (6,7,11) then 0 else payment_amount end) payment_category
  , min(case when payment_category in (6,7,11) then null else payment_time end) payment_date
  , max(case when payment_category in (6,7,11) then payment_time else null end) un_payment_date
  from decorate_order_pay -- where orders_no	= 'DD20180823000473'
group by orders_no) D on A.orders_no = D.orders_no
LEFT JOIN decorate_order_bussiness E on A.orders_no = E.orders_no
LEFT JOIN decorate_order_amount F on A.orders_no = F.orders_no
LEFT JOIN decorate_order_house G on A.orders_no = G.order_no;
*/
```
61001 日期
``` sql
select '2012-01-01' as Date
```

61002 推广渠道
``` sql
使用excel上传平台进行更新
```

61003 用户信息
``` sql
select user_id , name from user_info;
```

61004 订单状态
``` sql
SELECT
order_states -- 合同状态编码
,interior_name -- 对内显示名称
,outside_name -- 对外显示名称
,state -- '是否可用状态 0 可用 1 不可用',
FROM decorate_order_state
```

61005 区域
``` sql
select area_code 
,REPLACE(group_name,'默认组','') group_name 
,REPLACE(group_name,'体验店默认组','') city 
,case  when group_name in ('北京体验店默认组','上海体验店默认组','广州体验店默认组','深圳体验店默认组') then '第一方面军' else
			case when group_name in ('郑州体验店默认组','西安体验店默认组','成都体验店默认组','天津体验店默认组') then '第二方面军' else 
						case when group_name in ('苏州体验店默认组','武汉体验店默认组','重庆体验店默认组','杭州体验店默认组') then '第三方面军' else 
										case when group_name in ('廊坊体验店默认组','昆明体验店默认组','哈尔滨体验店默认组','南京体验店默认组','济南体验店默认组','南昌体验店默认组','太原体验店默认组') then '第四方面军' else 
										'其他方面军' end
						end
		end
 end front_name		
 from im_default_group;

```

61006 房屋区域表
``` sql
select 
id
,name
,region_type
,parent_id
,code
,full_name
,state
from region;
```

61007 房屋属性（现房期房）
``` sql
select '1'  as code , '现房' as name union all
select '2'  as code , '预测房' as name union all
select '3'  as code , '期房' as name 
```

61008 新老房
``` sql

select '0'  as code , '新房' as name union all
select '1'  as code , '旧房' as name 
```

61009 回款详情表
``` sql
/*
select a.id 
,a.orders_no
,company
,payment_category
,case when payment_category in (6,7,11) then payment_amount*-1 else payment_amount end payment_amount
,payment_time
,a.create_time
,b.area_code
,b.platform
,case when c.source_no  is null or c.source_no='' then b.platform else c.source_no end as source_no 
 from decorate_order_pay a 
left JOIN decorate_order b on a.orders_no = b.orders_no 
left join decorate_order_source c on a.orders_no = c.orders_no 
*/
-- 20181210更新，使用浩哥的逻辑进行处理
select a.id 
,a.orders_no
,a.first_orders_no
,a.company
,payment_category
,case when payment_category in (6,7,11) then payment_amount*-1 else payment_amount end payment_amount
,payment_time
,a.create_time
,b.area_code
,b.platform
,case when c.source_no  is null or c.source_no='' then b.platform else c.source_no end as source_no 
 from (

		select * from decorate_order_pay dop left JOIN 
		(
		select aa.orders_no as orders_no_1,bb.first_orders_no from decorate_order aa left join (select user_id
		,case when create_time = min(create_time) then orders_no else orders_no end first_orders_no
		 from decorate_order 
		-- where id <= 10
		group by user_id ) bb on aa.user_id = bb.user_id 
		) y on dop.orders_no = y.orders_no_1

) a 
left JOIN decorate_order b on a.first_orders_no = b.orders_no 
left join decorate_order_source c on a.first_orders_no = c.orders_no 
```

61010 platform平台维度表
``` sql
select 
a.name platform
,a.code platform_code
,b.name parent_platform
,b.code parent_platform_code
-- ,a.qtype -- '0代表线下1代表官网3代表第三方渠道',
from qudao a inner join qudao b on a.parent_code =b.code
where a.level = 2
order by b.code
```

61011 通话记录表
``` sql 
select -- id
-- ,call_sheet_id-- '通话记录的ID',
call_id-- '通话ID',
,end-begin as call_length  -- 通话时长 单位 秒
,case  when state ='dealing' then 1 else 0 end as call_turn_on_state  -- 是否接通  1是 0 否
-- ,case  when  state = 'leak' then 0 else 1 end as call_state  -- 是否外呼 1是 0 否
,call_type-- '呼叫类型包括： normal普通来电，dialout外呼通话，transfer转接电话，dialtransfer外呼转接',
,call_no-- '主叫号码',
,called_no-- '被叫号码',
,ring-- '开始呼叫时间',
,ringing_time-- '响铃时间',
,begin -- '摘机接通时间',
,end -- '通话结束时间',
-- ,queue_time-- '呼入来电进入技能组时间',
-- ,queue-- '呼入来电进入的技能组',
,agent-- '座席登录名',
,exten-- ,
,state-- '通话记录状态：已接听[dealing]，振铃未接听[notDeal]，已留言[voicemail]，黑名单[blackList]，排队放弃[queueLeak]，ivr [leak]',
-- ,monitor_filename-- '录音文件链接地址',
-- ,record_file-- '通话录音文件名',
,pbx-- '账户所在的PBX',
,agent_name-- '座席姓名',
,call_state-- '事件状态：Ring, Ringing, Link, Hangup(Unlink也当成Hangup处理)',
,province-- '省份',
,district-- '市区',
-- ,ivrkey-- 'ivr按键值',
-- ,survey_content-- '满意度调查按键',
from decorate_order_check_holly_call_record 
-- where agent = 8021
```


## 存储过程

``` sql

ALTER PROCEDURE [dbo].[PF_ETL_Conversion] 
	-- Add the parameters for the stored procedure here
	
AS
BEGIN
	
	if  exists(select *  from tempdb..sysobjects where name like '#T1%')
	     drop table #T1
     	
	if  exists(select *  from tempdb..sysobjects where name like '#T2%')
	     drop table #T2

	if  exists(select *  from tempdb..sysobjects where name like '#T3%')
				drop table #T3

	if  exists(select *  from tempdb..sysobjects where name like '#T4%')
				drop table #T4
	-- if  exists(select *  from tempdb..sysobjects where name like '#T3%')
	 --    drop table #T3

-- 按照规则取时间

/* -- 20181203 shg 更新规则，新增若所有时间小于订单创建时间则取订单创建时间
select 
	user_id
	,contract_date
	,case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end payment_date
	,case  doc_enter_store_date when  '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end doc_enter_store_date
	,case  doc_first_vaild_date when  '2099/12/31 00:00:00.000' then (case  doc_enter_store_date when '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end ) 
 else doc_first_vaild_date end doc_first_vaild_date
into #T1
from (
select user_id
	,min(case  when doc_first_vaild_date is null then '2099/12/31 00:00:00.000' else doc_first_vaild_date end)  doc_first_vaild_date
	,min( case  when doc_enter_store_date is null then '2099/12/31 00:00:00.000' else doc_enter_store_date end ) doc_enter_store_date
	,min( case  when payment_date is null then '2099/12/31 00:00:00.000' else payment_date end ) payment_date
	,min( case  when contract_date is null then '2099/12/31 00:00:00.000' else contract_date end ) contract_date
	from [dbo].[Fact_Decorate_Order]
	-- where user_id = 612303
	group by user_id ) a

20181203 shg */
select 
	user_id
	,contract_date
	,case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end payment_date
	,case  doc_enter_store_date when  '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end doc_enter_store_date
	,case  doc_first_vaild_date when  '2099/12/31 00:00:00.000' then (case  doc_enter_store_date when '2099/12/31 00:00:00.000' then (case  payment_date when  '2099/12/31 00:00:00.000'  then contract_date  else payment_date end)  else doc_enter_store_date end ) 
 else doc_first_vaild_date end doc_first_vaild_date
into #T1
from (
select user_id
	,min(case  when doc_first_vaild_date is null then '2099/12/31 00:00:00.000' else (case when doc_first_vaild_date<create_date then create_date else doc_first_vaild_date end) end)  doc_first_vaild_date
	,min( case  when doc_enter_store_date is null then '2099/12/31 00:00:00.000' else (case when doc_enter_store_date<create_date then create_date else doc_enter_store_date end) end ) doc_enter_store_date
	,min( case  when payment_date_500 is null then '2099/12/31 00:00:00.000' else (case when payment_date_500<create_date then create_date else payment_date_500 end) end ) payment_date
	,min( case  when contract_date is null then '2099/12/31 00:00:00.000' else (case when contract_date<create_date then create_date else contract_date end) end ) contract_date
	from [dbo].[Fact_Decorate_Order]
	-- where user_id = 612303
	group by user_id ) a





select a.user_id 
,orders_no 
,Rank
,create_date
,create_time
,doc_first_vaild_user -- 首次有效人
,doc_first_vaild_date 
,doc_enter_store_date
,payment_date_500 as payment_date
,un_payment_date_500 as un_payment_date
,contract_date
,amount
,total_amount
,payment_category
,un_payment_category
,order_states -- 订单状态
,area_code　-- 区域
,source_no -- 渠道编号
,platform -- 平台编号
,deposit_pay_sign
 into #T2
from (select top 1000000*,Row_Number()OVER(PARTITION BY user_id ORDER BY user_id,create_date,create_time) AS Rank from [dbo].[Fact_Decorate_Order]
 order by user_id,create_date) a where Rank=1

 

 select user_id
,Sum(amount) amount 
	,sum(total_amount) total_amount
	,SUM(payment_category) payment_category
	,SUM(un_payment_category) un_payment_category
into #T3 from [dbo].[Fact_Decorate_Order] group by user_id

/*
begin 20181217 穿刺表新增用户签约数量字段
*/
select user_id 
,COUNT(contract_date) as contract_date_num -- 用户签约订单数量
,min(case when payment_date_500 is not null and (order_states='400' or payment_category=un_payment_category ) then un_payment_date_500 else null end) as un_payment_date_500 -- 用户退订时间
,count(case when payment_date_500 is not null and (order_states='400' or payment_category=un_payment_category ) then un_payment_date_500 else null end) as un_payment_date_num -- 用户退订单数
,count(payment_date_500) payment_date_num -- 用户交订单数
into #T4 
from Fact_Decorate_Order
group by user_id 
/*
begin 20181217
*/

  TRUNCATE table Fact_Decorate_Order_User

  insert into  Fact_Decorate_Order_User

 -- drop table Fact_Decorate_Order_User

 select 
	b.orders_no
,b.create_date
,b.create_time
	,a.user_id
	,case a.doc_first_vaild_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.doc_first_vaild_date) end doc_first_vaild_date
	,case a.doc_enter_store_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.doc_enter_store_date) end doc_enter_store_date
	,case a.payment_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.payment_date) end payment_date
	,d.un_payment_date_500 -- 20181217 最早退订时间
	,case a.contract_date when '2099/12/31 00:00:00.000' then NULL else convert(datetime,a.contract_date) end contract_date 

	,case a.doc_first_vaild_date when  '2099/12/31 00:00:00.000' then 0 else 1  end doc_first_vaild_date_state
	,case a.doc_enter_store_date when  '2099/12/31 00:00:00.000' then 0 else 1  end doc_enter_store_date_state
	,case a.payment_date when  '2099/12/31 00:00:00.000' then 0 else 1  end payment_date_state
	,case when d.un_payment_date_500 is null then 0 else 1 end un_payment_date_user_num  -- 20181217 退订人数
	,case a.contract_date when  '2099/12/31 00:00:00.000' then 0 else 1  end contract_date_state
	,d.contract_date_num  -- 20181217 签约订单数量
	,d.un_payment_date_num -- 20181217 用户退订单数
	,d.payment_date_num -- 20181217 用户交订单数
	,b.source_no
	,b.platform
	,b.area_code
	,b.order_states
	,c.amount
	,c.total_amount
	,c.payment_category
	,c.un_payment_category
	,b.doc_first_vaild_user   -- 首次有效人

-- into Fact_Decorate_Order_User
from #T1 a INNER JOIN #T2 b on a.user_id = b.user_id 
left JOIN #T3 c on a.user_id = c.user_id
left join #T4 d on a.user_id = d.user_id

/*
		20181213 增加订单明细标准表，与源表不同之处在于，每条订单对应了首次订单编号
start*/

TRUNCATE table Fact_Decorate_Order_Std

insert into  Fact_Decorate_Order_Std
SELECT
	b.orders_no AS first_orders_no,
	b.source_no as first_source_no,
	a.* -- INTO Fact_Decorate_Order_Std
FROM
	Fact_Decorate_Order a
LEFT JOIN (
	SELECT
		source_no,
		orders_no,
		user_id
	FROM
		Fact_Decorate_Order_user
) b ON a.user_id = b.user_id

/*
		20181213 增加订单明细标准表，与源表不同之处在于，每条订单对应了首次订单编号0
end*/




END

```

## 周转天数部分sql

2019年01月03日 14时49分07秒
``` sql
SELECT
	*
FROM
	stock_day_history
WHERE
	goods_no = '10001054'
AND logic_warehouse_no = 'L1014'
and bak_time  BETWEEN DATE_ADD('2018-12-31 00:00:00',INTERVAL -7 day) and '2018-12-31 00:00:00'
ORDER BY
	bak_time;


-- select * from stock_day_history_detail where goods_no = '10011263' and logic_warehouse_no = 'L1014' ORDER BY create_time ;



SELECT
	gvd.*, gv.*
FROM
	goods_voucher_detail gvd
LEFT JOIN goods_voucher gv ON gvd.goods_voucher_no = gv.goods_voucher_no
WHERE
	goods_no = '10001054'
AND buss_logic_warehouse_no = 'L1014'
and create_time BETWEEN DATE_ADD('2018-12-31 00:00:00',INTERVAL -7 day) and '2018-12-31 00:00:00' -- 当前日期到三十天前之间

-- and create_time BETWEEN '2018-01-01 00:00:00' and '2019-01-01 00:00:00'







select distidd from goods_voucher_detail
```

